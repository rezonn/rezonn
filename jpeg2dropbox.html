<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
<video id="video" autoplay playsinline></video>
<canvas id="canvas" onclick="this.webkitRequestFullscreen()"></canvas>
<canvas id="canvas2" onclick="this.webkitRequestFullscreen()"></canvas>
<style>:-webkit-full-screen {position:fixed;width:100%;height:auto;top:0;left:0;}</style>
<script>

function newhtml(tag,attributes,ths) {
  var rv = document.createElement(tag);
  for (var x in attributes) {
    if (x!="style") rv[x] = attributes[x];
    else {
      for (var s in attributes[x]) {
        rv.style[s] = attributes[x][s];
      }
    }
  }
  if (ths) ths.appendChild(rv);
  return rv;
}
  
console.log = function(text) {newhtml("div",{innerText:text},document.body)}

function ascript(src){
  return new Promise((resolve, reject) => {
    let script2 = document.createElement('script');
    script2.async = true;
    script2.onload = function() {resolve(script2)}
    script2.onerror = reject;
    script2.src = src;
    document.head.appendChild(script2);
  })
}

async function cameraId2stream(cameraId) {
    const constraints = {
        'audio': {'echoCancellation': true},
        'video': {'deviceId': cameraId}
        }
    return await navigator.mediaDevices.getUserMedia(constraints);
}

async function gotDevices() {
  (await navigator.mediaDevices.enumerateDevices()).map(mediaDevice => {
    console.log(mediaDevice.deviceId);
    video.srcObject = await cameraId2stream(mediaDevice.deviceId);
  });
}
navigator.mediaDevices.ondevicechange = gotDevices;

window.onload = async function(){

  navigator.mediaDevices.getUserMedia({video:true}).then(function (stream) {
    video.srcObject = stream;
  }).catch(function (error) {
    console.log(error);
  });



  gotDevices();
  last = Date.parse(new Date());
  if (!localStorage.getItem("dropbox")) localStorage.setItem("dropbox", prompt('Dropbox Authorization'));
  await ascript("https://huningxin.github.io/opencv.js/build/asm.js/opencv.js");
}

var frames = [];
var keyframe = 10;

async function blob2dropbox(blob,filename) {
  try {
    await fetch("https://content.dropboxapi.com/2/files/upload", {
      method:'POST',
      headers:{
        'Authorization':'Bearer '+localStorage.getItem("dropbox"),
        'Dropbox-API-Arg':JSON.stringify({path:filename,mode:"overwrite",autorename:true,mute:false}),
        'Content-Type':'application/octet-stream'
      },
      body:blob
    });
  } catch(e) {console.log("fetch error: "+e.message)}
}

async function main() {
  var dsize = new cv.Size(300, 300);

  cv.cvtColor(frames[0], frames[0], cv.COLOR_RGBA2GRAY, 0);
  cv.resize(frames[0], frames[0], dsize, 0, 0, cv.INTER_LINEAR);

  cv.cvtColor(frames[keyframe], frames[keyframe], cv.COLOR_RGBA2GRAY, 0);
  cv.resize(frames[keyframe], frames[keyframe], dsize, 0, 0, cv.INTER_LINEAR);

  dst = new cv.Mat();
  cv.subtract(frames[0],frames[keyframe],dst);

  var dsize = new cv.Size(10, 10);
  cv.resize(dst, dst, dsize, 0, 0, cv.INTER_LINEAR);


  cv.imshow('canvas2', dst);

  var sorted = Array.from(dst.data).sort(function(a,b){return a-b}).reverse();
  var dc = new Date(); dc = [dc.getFullYear(),dc.getMonth()+1,dc.getDay(),dc.getHours(),dc.getMinutes(),dc.getSeconds()].join("-");

  if (sorted[0]>50) {
    console.log([sorted[0],sorted[10],sorted[50]].join("_"));
    let blob = await (new Promise(resolve => canvas.toBlob(resolve)));
    
    blob2dropbox(blob, "/home/"+dc+".jpg");
    last = Date.parse(new Date());
  }
  dst.delete();
  frames.map(function(a,i){
    if (i==0 || i==keyframe)
    a.delete();
  })
  frames = [];
  if (Date.parse(new Date()) - last > 60000) {
    blob2dropbox((new Blob([dc], {type: 'text/plain'})), "/home/ok.txt");
    last = Date.parse(new Date());
  }
}




video.onplay = function(){
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  var ths = this;
  var ctx = canvas.getContext('2d');
  (async function loop() {
      if (!ths.paused && !ths.ended) {
        ctx.drawImage(ths, 0, 0);
        if (frames.length<keyframe+2) {
          if (frames.length==0 || frames.length==keyframe)
          frames.push( cv.imread(canvas) );
          else frames.push( 0 );
        }
        else {
          await main();
        }
        window.requestAnimationFrame(loop);
      }
  })();
}



/*
navigator.mediaDevices.addEventListener('devicechange', event => {
    gotDevices()
});
*/

</script>
</body>
</html>
