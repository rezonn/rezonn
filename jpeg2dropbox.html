<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
<video id="video" autoplay playsinline></video>
<canvas id="canvas" onclick="this.webkitRequestFullscreen()"></canvas>
<canvas id="canvas2" onclick="this.webkitRequestFullscreen()"></canvas>
<style>:-webkit-full-screen {position:fixed;width:100%;height:auto;top:0;left:0;}</style>
<script>

function ascript(src){
  return new Promise((resolve, reject) => {
    let script2 = document.createElement('script');
    script2.async = true;
    script2.onload = function() {resolve(script2)}
    script2.onerror = reject;
    script2.src = src;
    document.head.appendChild(script2);
  })
}

window.onload = async function(){
  await ascript("https://huningxin.github.io/opencv.js/build/asm.js/opencv.js");
}

var frames = [];
var keyframe = 10;

async function main() {
  cv.cvtColor(frames[0], frames[0], cv.COLOR_RGBA2GRAY, 0);
  cv.cvtColor(frames[keyframe], frames[keyframe], cv.COLOR_RGBA2GRAY, 0);
  let dst = new cv.Mat();
  cv.subtract(frames[0],frames[keyframe],dst);
  cv.imshow('canvas2', dst);
  var imd = canvas2.getContext("2d").getImageData(0,0,canvas2.width,canvas2.height).data;
  var m = 0;
  for (var j=0;j<imd.length;j++) {
    if (imd[j]>100) m++;
  }
  console.log(m);
  m = m-307200;
  if (m>100) {
    let blob = await (new Promise(resolve => canvas.toBlob(resolve)));
    try {
      const response = await fetch("https://content.dropboxapi.com/2/files/upload", 
      {
        method:'POST',
        headers:{
          'Authorization':'Bearer '+localStorage.getItem("dropbox"),
          'Dropbox-API-Arg':'{"path":"/home/'+Math.round(Math.random()*10000)+'.jpg","mode":"overwrite","autorename":true,"mute":false}',
          'Content-Type':'application/octet-stream'
        },
        body:blob
      });
    } catch(e) {console.log("fetch error: "+e.message)}
  }
  dst.delete();
  frames.map(function(a){
    a.delete();
  })
  frames = [];
}

navigator.mediaDevices.getUserMedia({video:true}).then(function (stream) {
  video.srcObject = stream;
}).catch(function (error) {
  console.log(error);
});

video.onplay = function(){
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  var ths = this;
  var ctx = canvas.getContext('2d');
  (async function loop() {
      if (!ths.paused && !ths.ended) {
        ctx.drawImage(ths, 0, 0);
        if (frames.length<30) frames.push( cv.imread(canvas) );
        else {
          await main();
        }
        window.requestAnimationFrame(loop);
      }
  })();
}

</script>
</body>
</html>

