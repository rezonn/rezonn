<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:-webkit-full-screen {position:fixed;width:100%;height:auto;top:0;left:0;} 
body {margin:0;background:#222;}
* {color:#eee;font-family:"Monaco";}
#LOG {overflow-y:scroll;height:100%;}
canvas {display:none}
</style>
</head>
<body>
<table width="100%" height="100%">
<tr>
<td><video id="video" autoplay playsinline onclick="this.webkitRequestFullscreen()"></video></td>
<td><div id="camlist"></div></td>
</tr>
<tr height="100%"><td colspan=2><div id="LOG"></div></td></tr>
</table>
<canvas id="canvas"></canvas>
<canvas id="canvas2"></canvas>
<script>

function newhtml(tag,attributes,ths) {
  var rv = document.createElement(tag);
  for (var x in attributes) {
    if (x!="style") rv[x] = attributes[x];
    else {
      for (var s in attributes[x]) {
        rv.style[s] = attributes[x][s];
      }
    }
  }
  if (ths) ths.appendChild(rv);
  return rv;
}

function ascript(src){
  return new Promise((resolve, reject) => {
    let script2 = document.createElement('script');
    script2.async = true;
    script2.onload = function() {resolve(script2)}
    script2.onerror = reject;
    script2.src = src;
    document.head.appendChild(script2);
  })
}

async function allStreams(type) {
  await navigator.mediaDevices.getUserMedia({"video":true});
  devices = await navigator.mediaDevices.enumerateDevices();
  var rv = [];
  for (var device of devices) {
    var deviceKind = type||device.kind.slice(0,-5);
    var constraints = {};
    constraints[deviceKind] = {"deviceId":device.deviceId};
    var stream = {constraints:constraints}
    stream.device = device;
    stream.constraints = constraints;
    stream.settings = [];
    stream.getMedia = async function() {
      return await navigator.mediaDevices.getUserMedia(this.constraints);
    }
    rv.push(stream);
  }
  return rv;
}

function local(tag) {
  if ( !localStorage.getItem(tag) ) localStorage.setItem(tag, prompt("Set tag ["+tag+"]"));
  return localStorage.getItem(tag);
}

window.onload = async function(){
  await ascript("https://huningxin.github.io/opencv.js/build/asm.js/opencv.js");


  streams = await allStreams();



  //video.srcObject = await streams[1].getMedia();


  camlist.innerText = "";
  
  streams.map(function(stream){
    
    newhtml("div",{innerText:stream.device.label,stream:stream,onclick:async function(){
      video.srcObject = await this.stream.getMedia();
    }},camlist);


  })

  last = Date.parse(new Date());
  setInterval(async function(){
    var athome_date = await (await fetch(local("athome"))).text();
    athome_date = Date.parse(new Date(athome_date))
    if (Date.parse(new Date()) - athome_date > 120000) athome = false;
    else athome = true;
    if (athome) console.log("at home")
  },2000);

  console.log = function(text) {newhtml("div",{innerText:text},LOG);LOG.scrollTop = LOG.scrollHeight;}
}

async function blob2dropbox(blob,filename) {
  try {
    await fetch("https://content.dropboxapi.com/2/files/upload", {
      method:'POST',
      headers:{
        'Authorization':'Bearer '+local("dropbox"),
        'Dropbox-API-Arg':JSON.stringify({path:filename,mode:"overwrite",autorename:true,mute:false}),
        'Content-Type':'application/octet-stream'
      },
      body:blob
    });
  } catch(e) {console.log("fetch error: "+e.message)}
}

var athome = false;

video.onplay = function(){
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  var ths = this;
  ths.frames = [];
  var ctx = canvas.getContext('2d');
  (async function loop() {
    if (!ths.timer) ths.timer = 10;
    else ths.timer--;
    if (ths.timer==0 || ths.timer==10) {
      ctx.drawImage(ths, 0, 0);
      ths.frames.push(cv.imread(canvas));
    }
    if (ths.frames.length==2 && !athome) {
      var frames = ths.frames;
      var dsize = new cv.Size(300, 300);
      cv.cvtColor(frames[0], frames[0], cv.COLOR_RGBA2GRAY, 0);
      cv.resize(frames[0], frames[0], dsize, 0, 0, cv.INTER_LINEAR);
      cv.cvtColor(frames[1], frames[1], cv.COLOR_RGBA2GRAY, 0);
      cv.resize(frames[1], frames[1], dsize, 0, 0, cv.INTER_LINEAR);
      dst = new cv.Mat();
      cv.subtract(frames[0],frames[1],dst);
      var dsize = new cv.Size(10, 10);
      cv.resize(dst, dst, dsize, 0, 0, cv.INTER_LINEAR);
      cv.imshow('canvas2', dst);
      var sorted = Array.from(dst.data).sort(function(a,b){return a-b}).reverse();
      var dc = new Date(); dc = [dc.getFullYear(),dc.getMonth()+1,dc.getDay(),dc.getHours(),dc.getMinutes(),dc.getSeconds()].join("-");
      if (sorted[0]>50 && !athome) {
        console.log([sorted[0],sorted[10],sorted[50]].join("_"));
        let blob = await (new Promise(resolve => canvas.toBlob(resolve)));
        blob2dropbox(blob, "/home/"+dc+".jpg");
        last = Date.parse(new Date());
      }
      dst.delete();
      frames[0].delete();
      frames[1].delete();
      ths.frames = [];
      if (Date.parse(new Date()) - last > 60000) {2
        blob2dropbox((new Blob([dc], {type: 'text/plain'})), "/home/ok.txt");
        last = Date.parse(new Date());
      }
    }
    
    window.requestAnimationFrame(loop);
  })();
}

</script>
</body>
</html>
