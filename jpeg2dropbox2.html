<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:-webkit-full-screen {position:fixed;width:100%;height:auto;top:0;left:0;} 
body {margin:0;background:#222;}
* {color:#eee;}
#camlist {position: absolute;z-index:3;}
canvas {display:none}
#LOG {overflow-y:scroll;top:70%;height:30%;position:fixed;bottom:0;width:100%;}
.video-container {position:absolute;top:0;bottom:0;width:100%;height:100%;overflow:hidden;}
.video-container #video {min-width:100%;min-height:100%;width:auto;height:auto;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);}
</style>
</head>
<body>
<div class="video-container">
  <video id="video" autoplay playsinline></video>
</div>
<div id="camlist"></div>
<div id="LOG"></div>
<canvas id="canvas"></canvas>
<script>

function newhtml(tag,attributes,ths) {
  var rv = document.createElement(tag);
  for (var x in attributes) {
    if (x!="style") rv[x] = attributes[x];
    else {
      for (var s in attributes[x]) {
        rv.style[s] = attributes[x][s];
      }
    }
  }
  if (ths) ths.appendChild(rv);
  return rv;
}

function ascript(src){
  return new Promise((resolve, reject) => {
    let script2 = document.createElement('script');
    script2.async = true;
    script2.onload = function() {resolve(script2)}
    script2.onerror = reject;
    script2.src = src;
    document.head.appendChild(script2);
  })
}

async function allStreams(type) {
  var constraints = {};
  if (!type) type = "video";
  constraints[type]=true;
  await navigator.mediaDevices.getUserMedia(constraints);
  devices = await navigator.mediaDevices.enumerateDevices();
  var rv = [];
  for (var device of devices) {
    var deviceKind = type||device.kind.slice(0,-5);
    var constraints = {};
    constraints[deviceKind] = {"deviceId":device.deviceId};
    var stream = {constraints:constraints}
    stream.device = device;
    stream.constraints = constraints;
    stream.settings = [];
    stream.getMedia = async function() {
      return await navigator.mediaDevices.getUserMedia(this.constraints);
    }
    if (!type || type==device.kind.slice(0,-5)) rv.push(stream);
  }
  return rv;
}

async function blob2dropbox(blob,filename) {
  try {
    await fetch("https://content.dropboxapi.com/2/files/upload", {
      method:'POST',
      headers:{
        'Authorization':'Bearer '+localStorage.getItem("dropbox"),
        'Dropbox-API-Arg':JSON.stringify({path:filename,mode:"overwrite",autorename:true,mute:false}),
        'Content-Type':'application/octet-stream'
      },
      body:blob
    });
  } catch(e) {console.log("fetch error: "+e.message)}
}

var athome = false;

var cap,left,right;
last = Date.parse(new Date());
canvas.ctx = canvas.getContext('2d');

video.onplay = function(){
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
}

async function Update() {
  canvas.ctx.drawImage(video, 0, 0);
  if (!left) left = cv.imread(canvas);
  else if (!right) right = cv.imread(canvas);
  else {
    left.delete();
    right.delete();
    left=undefined;
    right=undefined;
  }
  if (!athome && right && left && compare([right,left])) {
    console.log("DETECT");
    let blob = await (new Promise(resolve => canvas.toBlob(resolve)));
    var dc = new Date(); dc = [dc.getFullYear(),dc.getMonth()+1,dc.getDay(),dc.getHours(),dc.getMinutes(),dc.getSeconds()].join("-");
    await blob2dropbox(blob, "/home/"+dc+".jpg");
    console.log("uploaded");
    last = Date.parse(new Date());
  }
}

window.onload = async function(){
  console.log = function(text) {newhtml("div",{innerText:text},LOG);LOG.scrollTop = LOG.scrollHeight;}
  await ascript("https://huningxin.github.io/opencv.js/build/asm.js/opencv.js");
  streams = await allStreams();
  camlist.innerText = "";
  streams.map(function(stream){
    newhtml("div",{innerText:stream.device.label,stream:stream,onclick:async function(){
      video.srcObject = await this.stream.getMedia();
    }},camlist);
  });
  ["dropbox","athome","rotate","width","height","interval"].map(function(field){
    newhtml("div",{innerText:field},camlist);
    newhtml("input",{value:localStorage.getItem(field),field:field,style:{display:"block",background:"none"},onchange:function(){
      //window[this.field] == this.value; 
      localStorage.setItem(field, parseFloat(this.value).toString()==this.value?parseFloat(this.value):this.value);
    }},camlist);
  });

  (async function loop() {
    await Update();
    window.requestAnimationFrame(loop);
  })();

  setInterval(async function(){
    if (Date.parse(new Date()) - last > 60000) {
      var dc = new Date(); dc = [dc.getFullYear(),dc.getMonth()+1,dc.getDay(),dc.getHours(),dc.getMinutes(),dc.getSeconds()].join("-");
      await blob2dropbox((new Blob([dc], {type: 'text/plain'})), "/home/ok.txt");
      last = Date.parse(new Date());
    }
  },60000);

  setInterval(async function(){
    athome = false;
      try {
          var athome_date = await (await fetch(localStorage.getItem("athome"))).text();
          athome_date = Date.parse(new Date(athome_date))
          if (Date.parse(new Date()) - athome_date < 120000) athome = true;
      } catch(e){}
    if (athome) console.log("at home")
  },60000);

}
    
function compare(frames) {
  try {
    var dsize = new cv.Size(300, 300);
    cv.cvtColor(frames[0], frames[0], cv.COLOR_RGBA2GRAY, 0);
    cv.resize(frames[0], frames[0], dsize, 0, 0, cv.INTER_LINEAR);
    cv.cvtColor(frames[1], frames[1], cv.COLOR_RGBA2GRAY, 0);
    cv.resize(frames[1], frames[1], dsize, 0, 0, cv.INTER_LINEAR);
    dst = new cv.Mat();
    cv.subtract(frames[0],frames[1],dst);
    var dsize = new cv.Size(10, 10);
    cv.resize(dst, dst, dsize, 0, 0, cv.INTER_LINEAR);
    var sorted = Array.from(dst.data).sort(function(a,b){return a-b}).reverse();
    if (sorted[0]>50) return true;
  } catch(e) {console.log("compare error: "+e.message)}
}

</script>
</body>
</html>
