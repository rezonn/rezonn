<html>
<meta charset="UTF-8">
<style>
*{background:none;}
body{background:#555;}
</style>
<script src="tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-vis"></script>
<script src="client.js"></script>
<script src="sugar.js"></script>
<script src="tfgraf.js"></script>
<script>

async function makeData(count, func) {
  var data = [];
  var labels = [];
  for (var i=0;i<count;i++) {
    var item = func(i);
    if ((item.xs.tagName+"").toLowerCase()=="canvas") data.push(await tf.browser.fromPixels(item.xs,1));
    else if (Array.isArray(item.xs)) data.push(tf.tensor(item.xs));
    if ((item.ys.tagName+"").toLowerCase()=="canvas") labels.push(await tf.browser.fromPixels(item.ys,1));
    else if (Array.isArray(item.ys)) labels.push(tf.tensor(item.ys));
  }
  data2 = tf.stack(data);
  labels2 = tf.stack(labels);
  for (var i=0;i<count;i++) {
    data[i].dispose();
    labels[i].dispose();
  }
  return {xs:data2,ys:labels2};
}

function showmemory() {
    var m = tf.memory();
    state.innerText = [
      ["Bytes", m.numBytes/1000000 >> 0],
      ["BytesInGPU", m.numBytesInGPU/1000000 >> 0],
      ["DataBuffers", m.numDataBuffers],
      ["Tensors", m.numTensors],
    ].join(", ");
}

const randint = (min,max)=>Math.round(Math.random()*(max-min))+Math.round(min);
const maxp = (scale)=>tf.layers.maxPooling2d({poolSize:[scale,scale],strides:[2,2]});
const actv = ()=>tf.layers.activation({activation:"relu"});
var norm = ()=>tf.layers.batchNormalization();
const convdw = (scale)=>tf.layers.depthwiseConv2d({kernelSize:[3,3],padding:"same",strides:[2,2]});
rand = (min,max)=>Math.round(Math.random()*(max-min))+Math.round(min);
const conv2d = (f,k)=>tf.layers.conv2d({kernelSize:k,padding:"same",filters:f,strides:1,activation:'relu',kernelInitializer:'varianceScaling'});

function makemodel(inputShape,classes) {
  var input = tf.input({shape:inputShape});
  var c1 = conv2d(8,3).apply(input);
  var c1 = norm().apply(c1);
  var c1 = maxp(2).apply(c1);
  var c1 = norm().apply(c1);
  var c1 = conv2d(16,3).apply(c1);
  var c1 = norm().apply(c1);
  var c1 = maxp(2).apply(c1);
  var c1 = norm().apply(c1);
  var c1 = tf.layers.flatten().apply(c1);
  var output = tf.layers.dense({units:classes, activation:"softmax"}).apply(c1);
  var model = tf.model({inputs:input,outputs:output});
  model.compile({optimizer:tf.train.adam(),loss:'categoricalCrossentropy',metrics:['accuracy']});
  return model;
}

window.onload = async function() {
  var classes = 5;
  var [w,h] = [28,28];

  model = makemodel([w,h,1],classes);

  var div = newhtml("div",{style:{width:"100%",height:300,borderWidth:1,borderColor:"#111",borderStyle:"solid"}},document.body);
  visualizeModel(div, model);


  var fitCallbacks = await tfvis.show.fitCallbacks(trainview,["loss", "val_loss", "acc", "val_acc"]);
  fitCallbacks.onBatchEnd = undefined;


  /*
  for (var i=0;i<2000;i++) {
    var data = await makeData(20, (j)=>{
      var cax = newhtml("canvas",{width:w,height:h});
      var ctx = cax.getContext("2d");
      var cay = newhtml("canvas",{width:w,height:h});
      var labels = Array(classes).fill(0) ;
      var text = rand(0,classes-1);
      var font = rand(w*0.5,w*0.8);
      var [x,y] = [rand(0,w-font),rand(font,h)];
      ctx.fillStyle = "white";
      ctx.font = font+"px Georgia";
      ctx.fillText(text, x, y);
      labels[text]=1;
      if (j<5 && i==0) {
        modelview.appendChild(cax);
        console.log(labels);
      }
      return {xs:cax,ys:labels}
    });
    const h1 = await model.fit(data.xs,data.ys,{epochs:1,batchSize:10,shuffle:true,callbacks:fitCallbacks,validationSplit:0.1});
    data.xs.dispose();
    data.ys.dispose();
  }
  */

}

</script>

<body>
<div class="parent"> 
<div id="state"></div> 
<div id="modelview"></div> 
<div id="samples"></div> 
<div id="trainview"></div> 
<div id="ssdview"></div> 
<code id="logger"></code> 
</div>
</body>
